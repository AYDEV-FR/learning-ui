# Learning UI Container
# Generic web interface - scenarios are mounted via ConfigMap

# Build stage
FROM golang:1.22-alpine AS builder

WORKDIR /build

# Install dependencies
RUN apk add --no-cache git

# Copy go mod files
COPY go.mod go.sum* ./
RUN go mod download

# Copy source code
COPY main.go ./
COPY web/ ./web/

# Build the binary
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o learning-ui .

# Runtime stage
FROM alpine:3.19

WORKDIR /app

# Install kubectl for executing checks in shell pod
RUN apk add --no-cache ca-certificates curl bash && \
    ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi && \
    if [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi && \
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/${ARCH}/kubectl" && \
    chmod +x kubectl && \
    mv kubectl /usr/local/bin/

# Copy binary from builder
COPY --from=builder /build/learning-ui /app/learning-ui

# Create scenarios mount point
RUN mkdir -p /scenarios

# Create non-root user
RUN adduser -D -u 1000 learning && \
    chown -R learning:learning /app /scenarios

USER learning

EXPOSE 8080

ENV PORT=8080
ENV SCENARIO_PATH=/scenarios

CMD ["/app/learning-ui"]
